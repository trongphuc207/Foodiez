import React, { useState } from 'react';
import { useAuth } from '../../hooks/useAuth';
import ComplaintForm from '../ComplaintComponent/ComplaintForm';
import './Review.css';

export default function ReviewList({ reviews = [], onEdit, onDelete, onReply, userRole = 'customer' }) {
  const { user } = useAuth();
  const [replyingTo, setReplyingTo] = useState(null);
  const [replyText, setReplyText] = useState('');
  const [complainingTo, setComplainingTo] = useState(null);

  if (!reviews || reviews.length === 0) {
    return (
      <div className="review-empty">
        <div className="empty-icon">‚≠ê</div>
        <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</p>
        <small>H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n ƒë√°nh gi√° s·∫£n ph·∫©m n√†y!</small>
      </div>
    );
  }

  const handleReply = (reviewId) => {
    if (replyText.trim()) {
      onReply(reviewId, replyText.trim());
      setReplyText('');
      setReplyingTo(null);
    }
  };

  const canEditReview = (review) => {
    return user && (user.id === review.userId || user.role === 'admin');
  };

  const canDeleteReview = (review) => {
    return user && (user.id === review.userId || user.role === 'admin');
  };

  const canReplyToReview = (review) => {
    return user && (user.role === 'merchant' || user.role === 'admin') && review.userId !== user.id;
  };

  return (
    <div className="review-list">
      {reviews.map((review) => (
        <div key={review.id} className="review-item">
          <div className="review-header">
            <div className="review-author-info">
              <div className="review-author">{review.user?.name || review.userName || 'Ng∆∞·ªùi d√πng'}</div>
              <div className="review-verified">
                {review.isVerified ? '‚úì ƒê√£ x√°c th·ª±c' : 'Ch∆∞a x√°c th·ª±c'}
              </div>
            </div>
            <div className="review-rating">
              <div className="stars">
                {'‚òÖ'.repeat(review.rating || 0)}
                {'‚òÜ'.repeat(5 - (review.rating || 0))}
              </div>
              <span className="rating-number">({review.rating}/5)</span>
            </div>
          </div>
          
          <div className="review-content">
            <div className="review-comment">{review.comment}</div>
            
            {/* Hi·ªÉn th·ªã reply c·ªßa merchant */}
            {review.merchantReply && (
              <div className="merchant-reply">
                <div className="reply-header">
                  <span className="reply-author">üè™ Ph·∫£n h·ªìi t·ª´ c·ª≠a h√†ng</span>
                  <span className="reply-date">
                    {new Date(review.merchantReply.createdAt).toLocaleString()}
                  </span>
                </div>
                <div className="reply-content">{review.merchantReply.content}</div>
              </div>
            )}
          </div>
          
          <div className="review-footer">
            <div className="review-meta">
              <span className="review-date">
                {new Date(review.createdAt || review.created_at || Date.now()).toLocaleString()}
              </span>
              {review.updatedAt && review.updatedAt !== review.createdAt && (
                <span className="review-updated">(ƒê√£ ch·ªânh s·ª≠a)</span>
              )}
            </div>
            
            <div className="review-actions">
              {/* N√∫t tr·∫£ l·ªùi cho merchant */}
              {canReplyToReview(review) && !review.merchantReply && (
                <button 
                  className="review-btn reply-btn"
                  onClick={() => setReplyingTo(replyingTo === review.id ? null : review.id)}
                >
                  üí¨ Tr·∫£ l·ªùi
                </button>
              )}
              
              {/* N√∫t ch·ªânh s·ª≠a cho ch·ªß review ho·∫∑c admin */}
              {canEditReview(review) && (
                <button 
                  className="review-btn edit-btn" 
                  onClick={() => onEdit(review)}
                >
                  ‚úèÔ∏è S·ª≠a
                </button>
              )}
              
              {/* N√∫t x√≥a cho ch·ªß review ho·∫∑c admin */}
              {canDeleteReview(review) && (
                <button 
                  className="review-btn danger-btn" 
                  onClick={() => {
                    if (window.confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë√°nh gi√° n√†y?')) {
                      onDelete(review.id);
                    }
                  }}
                >
                  üóëÔ∏è X√≥a
                </button>
              )}
              
              {/* N√∫t khi·∫øu n·∫°i cho user kh√°c (kh√¥ng ph·∫£i ch·ªß review) */}
              {user && user.id !== review.userId && (
                <button 
                  className="review-btn complaint-btn" 
                  onClick={() => setComplainingTo(review.id)}
                >
                  üö® Khi·∫øu n·∫°i
                </button>
              )}
            </div>
          </div>
          
          {/* Form tr·∫£ l·ªùi */}
          {replyingTo === review.id && (
            <div className="reply-form">
              <textarea
                value={replyText}
                onChange={(e) => setReplyText(e.target.value)}
                placeholder="Vi·∫øt ph·∫£n h·ªìi cho kh√°ch h√†ng..."
                rows={3}
              />
              <div className="reply-actions">
                <button 
                  className="cancel-reply-btn"
                  onClick={() => {
                    setReplyingTo(null);
                    setReplyText('');
                  }}
                >
                  H·ªßy
                </button>
                <button 
                  className="send-reply-btn"
                  onClick={() => handleReply(review.id)}
                  disabled={!replyText.trim()}
                >
                  G·ª≠i ph·∫£n h·ªìi
                </button>
              </div>
            </div>
          )}
          
          {/* Complaint Form */}
          {complainingTo === review.id && (
            <ComplaintForm
              reviewId={review.id}
              onSuccess={() => {
                setComplainingTo(null);
                alert('Khi·∫øu n·∫°i ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!');
              }}
              onCancel={() => setComplainingTo(null)}
            />
          )}
        </div>
      ))}
    </div>
  );
}








