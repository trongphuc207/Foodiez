import React, { useState } from 'react';
import './Notification.css';
import { useMarkAsRead, useMarkAllAsRead } from '../../hooks/useNotifications';

export default function NotificationList({ 
  notifications = [], 
  userId, 
  userRole, 
  showFilters = false,
  showPriority = false 
}) {
  const [filterType, setFilterType] = useState('ALL');
  const [filterPriority, setFilterPriority] = useState('ALL');
  
  const markAsRead = useMarkAsRead();
  const markAll = useMarkAllAsRead(userId);

  const handleMarkAll = () => {
    if (notifications.length === 0) return;
    markAll.mutate();
  };

  const handleMarkAsRead = (notificationId) => {
    markAsRead.mutate(notificationId);
  };

  const getNotificationIcon = (type) => {
    switch (type) {
      case 'ORDER_STATUS':
        return 'üì¶';
      case 'PROMOTION':
        return 'üéâ';
      case 'DELIVERY':
        return 'üöö';
      case 'SYSTEM':
        return 'üîî';
      case 'REVIEW':
        return '‚≠ê';
      default:
        return 'üì¢';
    }
  };

  const getPriorityClass = (priority) => {
    switch (priority) {
      case 'URGENT':
        return 'priority-urgent';
      case 'HIGH':
        return 'priority-high';
      case 'NORMAL':
        return 'priority-normal';
      case 'LOW':
        return 'priority-low';
      default:
        return 'priority-normal';
    }
  };

  const filteredNotifications = notifications.filter(notification => {
    const typeMatch = filterType === 'ALL' || notification.type === filterType;
    const priorityMatch = filterPriority === 'ALL' || notification.priority === filterPriority;
    return typeMatch && priorityMatch;
  });

  const notificationTypes = [...new Set(notifications.map(n => n.type))];
  const notificationPriorities = [...new Set(notifications.map(n => n.priority))];

  return (
    <div className="notif-list">
      <div className="notif-header">
        <h3>Th√¥ng b√°o</h3>
        <div className="notif-actions">
          {showFilters && (
            <div className="notif-filters">
              <select 
                value={filterType} 
                onChange={(e) => setFilterType(e.target.value)}
                className="notif-filter"
              >
                <option value="ALL">T·∫•t c·∫£ lo·∫°i</option>
                {notificationTypes.map(type => (
                  <option key={type} value={type}>
                    {type === 'ORDER_STATUS' ? 'ƒê∆°n h√†ng' :
                     type === 'PROMOTION' ? 'Khuy·∫øn m√£i' :
                     type === 'DELIVERY' ? 'Giao h√†ng' :
                     type === 'SYSTEM' ? 'H·ªá th·ªëng' :
                     type === 'REVIEW' ? 'ƒê√°nh gi√°' : type}
                  </option>
                ))}
              </select>
              {showPriority && (
                <select 
                  value={filterPriority} 
                  onChange={(e) => setFilterPriority(e.target.value)}
                  className="notif-filter"
                >
                  <option value="ALL">T·∫•t c·∫£ m·ª©c ƒë·ªô</option>
                  {notificationPriorities.map(priority => (
                    <option key={priority} value={priority}>
                      {priority === 'URGENT' ? 'Kh·∫©n c·∫•p' :
                       priority === 'HIGH' ? 'Cao' :
                       priority === 'NORMAL' ? 'B√¨nh th∆∞·ªùng' :
                       priority === 'LOW' ? 'Th·∫•p' : priority}
                    </option>
                  ))}
                </select>
              )}
            </div>
          )}
          <button className="notif-btn" onClick={handleMarkAll}>
            ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
          </button>
        </div>
      </div>
      
      {filteredNotifications.length === 0 ? (
        <div className="notif-empty">
          {notifications.length === 0 ? 'Kh√¥ng c√≥ th√¥ng b√°o' : 'Kh√¥ng c√≥ th√¥ng b√°o ph√π h·ª£p v·ªõi b·ªô l·ªçc'}
        </div>
      ) : (
        <div className="notif-items">
          {filteredNotifications.map((n) => (
            <div 
              key={n.id} 
              className={`notif-item ${n.read || n.isRead ? 'read' : 'unread'} ${getPriorityClass(n.priority)}`}
            >
              <div className="notif-icon">
                {getNotificationIcon(n.type)}
              </div>
              <div className="notif-content">
                <div className="notif-title">
                  {n.title || 'Th√¥ng b√°o'}
                  {showPriority && n.priority === 'URGENT' && (
                    <span className="priority-badge urgent">Kh·∫©n c·∫•p</span>
                  )}
                  {showPriority && n.priority === 'HIGH' && (
                    <span className="priority-badge high">Quan tr·ªçng</span>
                  )}
                </div>
                <div className="notif-message">{n.message}</div>
                <div className="notif-meta">
                  <span className="notif-type">
                    {n.type === 'ORDER_STATUS' ? 'ƒê∆°n h√†ng' :
                     n.type === 'PROMOTION' ? 'Khuy·∫øn m√£i' :
                     n.type === 'DELIVERY' ? 'Giao h√†ng' :
                     n.type === 'SYSTEM' ? 'H·ªá th·ªëng' :
                     n.type === 'REVIEW' ? 'ƒê√°nh gi√°' : n.type}
                  </span>
                  <span className="notif-time">
                    {new Date(n.createdAt || n.created_at || Date.now()).toLocaleString()}
                  </span>
                </div>
              </div>
              <div className="notif-actions">
                {!n.read && !n.isRead && (
                  <button 
                    className="notif-btn small" 
                    onClick={() => handleMarkAsRead(n.id)}
                  >
                    ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
                  </button>
                )}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}








