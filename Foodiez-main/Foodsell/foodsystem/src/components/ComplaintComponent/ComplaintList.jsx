import React, { useState } from 'react';
import { useAuth } from '../../hooks/useAuth';
import { complaintAPI } from '../../api/complaint';
import './Complaint.css';

const STATUS_COLORS = {
  PENDING: '#ff9800',
  UNDER_REVIEW: '#2196f3',
  RESOLVED: '#4caf50',
  REJECTED: '#f44336',
  CLOSED: '#9e9e9e'
};

const STATUS_LABELS = {
  PENDING: 'Ch·ªù x·ª≠ l√Ω',
  UNDER_REVIEW: 'ƒêang xem x√©t',
  RESOLVED: 'ƒê√£ gi·∫£i quy·∫øt',
  REJECTED: 'T·ª´ ch·ªëi',
  CLOSED: 'ƒê√≥ng'
};

const COMPLAINT_TYPE_LABELS = {
  INAPPROPRIATE_CONTENT: 'N·ªôi dung kh√¥ng ph√π h·ª£p',
  FAKE_REVIEW: 'ƒê√°nh gi√° gi·∫£ m·∫°o',
  SPAM: 'Spam',
  HARASSMENT: 'Qu·∫•y r·ªëi',
  COPYRIGHT_VIOLATION: 'Vi ph·∫°m b·∫£n quy·ªÅn',
  OTHER: 'Kh√°c'
};

export default function ComplaintList({ complaints, onUpdate, userRole = 'customer' }) {
  const { user } = useAuth();
  const [resolvingComplaint, setResolvingComplaint] = useState(null);
  const [resolutionData, setResolutionData] = useState({
    status: 'RESOLVED',
    adminNotes: '',
    resolution: ''
  });

  const handleResolveComplaint = async (complaintId) => {
    try {
      await complaintAPI.resolveComplaint(complaintId, resolutionData);
      alert('Gi·∫£i quy·∫øt khi·∫øu n·∫°i th√†nh c√¥ng!');
      setResolvingComplaint(null);
      setResolutionData({
        status: 'RESOLVED',
        adminNotes: '',
        resolution: ''
      });
      if (onUpdate) {
        onUpdate();
      }
    } catch (error) {
      console.error('Error resolving complaint:', error);
      alert('C√≥ l·ªói x·∫£y ra khi gi·∫£i quy·∫øt khi·∫øu n·∫°i');
    }
  };

  const handleUpdateStatus = async (complaintId, status) => {
    try {
      await complaintAPI.updateComplaintStatus(complaintId, status);
      alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
      if (onUpdate) {
        onUpdate();
      }
    } catch (error) {
      console.error('Error updating status:', error);
      alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i');
    }
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleString('vi-VN');
  };

  if (!complaints || complaints.length === 0) {
    return (
      <div className="complaint-list-container">
        <div className="complaint-empty">
          <div className="empty-icon">üìù</div>
          <p>Ch∆∞a c√≥ khi·∫øu n·∫°i n√†o</p>
        </div>
      </div>
    );
  }

  return (
    <div className="complaint-list-container">
      <div className="complaint-list-header">
        <h3>üìã Danh s√°ch khi·∫øu n·∫°i ({complaints.length})</h3>
      </div>

      <div className="complaint-list">
        {complaints.map(complaint => (
          <div key={complaint.id} className="complaint-item">
            <div className="complaint-header">
              <div className="complaint-info">
                <span className="complaint-id">#{complaint.id}</span>
                <span 
                  className="complaint-status"
                  style={{ backgroundColor: STATUS_COLORS[complaint.status] }}
                >
                  {STATUS_LABELS[complaint.status]}
                </span>
                <span className="complaint-type">
                  {COMPLAINT_TYPE_LABELS[complaint.complaintType]}
                </span>
              </div>
              <div className="complaint-date">
                {formatDate(complaint.createdAt)}
              </div>
            </div>

            <div className="complaint-content">
              <div className="complaint-reason">
                <strong>L√Ω do:</strong> {complaint.complaintReason}
              </div>
              
              {complaint.complaintDetails && (
                <div className="complaint-details">
                  <strong>Chi ti·∫øt:</strong> {complaint.complaintDetails}
                </div>
              )}

              <div className="complaint-meta">
                <span><strong>Review ID:</strong> {complaint.reviewId}</span>
                <span><strong>Ng∆∞·ªùi b√°o c√°o:</strong> {complaint.reporterName}</span>
              </div>
            </div>

            {complaint.adminNotes && (
              <div className="admin-notes">
                <strong>Ghi ch√∫ Admin:</strong> {complaint.adminNotes}
              </div>
            )}

            {complaint.resolution && (
              <div className="resolution">
                <strong>Gi·∫£i ph√°p:</strong> {complaint.resolution}
              </div>
            )}

            {complaint.resolvedAt && (
              <div className="resolution-info">
                <span>Gi·∫£i quy·∫øt l√∫c: {formatDate(complaint.resolvedAt)}</span>
              </div>
            )}

            {/* Admin actions */}
            {userRole === 'admin' && (
              <div className="complaint-actions">
                {complaint.status === 'PENDING' && (
                  <>
                    <button
                      className="action-btn review-btn"
                      onClick={() => handleUpdateStatus(complaint.id, 'UNDER_REVIEW')}
                    >
                      Xem x√©t
                    </button>
                    <button
                      className="action-btn resolve-btn"
                      onClick={() => setResolvingComplaint(complaint.id)}
                    >
                      Gi·∫£i quy·∫øt
                    </button>
                  </>
                )}

                {complaint.status === 'UNDER_REVIEW' && (
                  <button
                    className="action-btn resolve-btn"
                    onClick={() => setResolvingComplaint(complaint.id)}
                  >
                    Gi·∫£i quy·∫øt
                  </button>
                )}

                <button
                  className="action-btn reject-btn"
                  onClick={() => handleUpdateStatus(complaint.id, 'REJECTED')}
                >
                  T·ª´ ch·ªëi
                </button>

                <button
                  className="action-btn close-btn"
                  onClick={() => handleUpdateStatus(complaint.id, 'CLOSED')}
                >
                  ƒê√≥ng
                </button>
              </div>
            )}
          </div>
        ))}
      </div>

      {/* Resolution Modal */}
      {resolvingComplaint && (
        <div className="resolution-modal">
          <div className="resolution-modal-content">
            <div className="modal-header">
              <h3>Gi·∫£i quy·∫øt khi·∫øu n·∫°i #{resolvingComplaint}</h3>
              <button
                className="close-modal-btn"
                onClick={() => setResolvingComplaint(null)}
              >
                ‚úï
              </button>
            </div>

            <div className="modal-body">
              <div className="form-group">
                <label>Tr·∫°ng th√°i</label>
                <select
                  value={resolutionData.status}
                  onChange={(e) => setResolutionData(prev => ({
                    ...prev,
                    status: e.target.value
                  }))}
                  className="form-select"
                >
                  <option value="RESOLVED">ƒê√£ gi·∫£i quy·∫øt</option>
                  <option value="REJECTED">T·ª´ ch·ªëi</option>
                  <option value="CLOSED">ƒê√≥ng</option>
                </select>
              </div>

              <div className="form-group">
                <label>Ghi ch√∫ Admin</label>
                <textarea
                  value={resolutionData.adminNotes}
                  onChange={(e) => setResolutionData(prev => ({
                    ...prev,
                    adminNotes: e.target.value
                  }))}
                  placeholder="Ghi ch√∫ n·ªôi b·ªô..."
                  className="form-textarea"
                  rows={3}
                />
              </div>

              <div className="form-group">
                <label>Gi·∫£i ph√°p</label>
                <textarea
                  value={resolutionData.resolution}
                  onChange={(e) => setResolutionData(prev => ({
                    ...prev,
                    resolution: e.target.value
                  }))}
                  placeholder="M√¥ t·∫£ gi·∫£i ph√°p ƒë√£ th·ª±c hi·ªán..."
                  className="form-textarea"
                  rows={3}
                />
              </div>
            </div>

            <div className="modal-actions">
              <button
                className="cancel-btn"
                onClick={() => setResolvingComplaint(null)}
              >
                H·ªßy
              </button>
              <button
                className="submit-btn"
                onClick={() => handleResolveComplaint(resolvingComplaint)}
              >
                X√°c nh·∫≠n
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
